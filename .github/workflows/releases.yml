name: Release
on:
    push:
        tags: 
            - 'v*'

jobs:
    release:
        permissions: 
            contents: write
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: 'macos-latest'
                      args: '--target universal-apple-darwin'

                    - platform: 'ubuntu-22.04'
                      args: ''

                    - platform: 'windows-latest'
                      args: ''

        runs-on: ${{ matrix.platform }}
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Get Version
              id: get_version
              shell: bash
              run: echo "VERSION=$(jq -r .version src-tauri/tauri.conf.json)" >> $GITHUB_OUTPUT

            - name: Get Release Notes
              id: release_notes
              shell: bash
              run: |
                VERSION="${{ steps.get_version.outputs.VERSION }}"
                NOTES=$(awk -v ver="[$VERSION]" '/^## / { if (p) { exit }; if ($2 == ver) { p=1; next } } p' CHANGELOG.md)

                if [ -z "$NOTES" ]; then
                  NOTES="No specific release notes found for this version."
                fi

                echo "BODY<<EOF" >> $GITHUB_OUTPUT
                echo "$NOTES" >> $GITHUB_OUTPUT
                echo "EOF" >> $GITHUB_OUTPUT

            - name: Install Linux (Ubuntu Only) Prerequisites
              if: matrix.platform == 'ubuntu-22.04'
              run: |
                sudo apt-get update
                sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf rpm

            - name: Rust Installation
              uses: dtolnay/rust-toolchain@stable
              with:
                targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

            - name: Install pnpm
              uses: pnpm/action-setup@v3
              with:
                version: latest

            - name: Node.js Installation
              uses: actions/setup-node@v4
              with:
                node-version: lts/*
                cache: pnpm

            - name: Install Frontend Dependencies
              run: pnpm install

            - name: "Build and Release"
              uses: tauri-apps/tauri-action@v0
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
                TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
              with:
                tagName: 'v__VERSION__'
                releaseName: 'App v__VERSION__'
                releaseBody: ${{ steps.release_notes.outputs.BODY }}
                releaseDraft: false
                prerelease: false
                args: ${{ matrix.args }}

